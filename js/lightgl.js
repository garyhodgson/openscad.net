/*
 * lightgl.js
 * http://github.com/evanw/lightgl.js/
 *
 * Copyright 2011 Evan Wallace
 * Released under the MIT license
 */
 var GL=function(){function c(){a.MODELVIEW=1|j,a.PROJECTION=2|j;var b=new l,c=new l;a.modelviewMatrix=new l,a.projectionMatrix=new l;var f,g,d=[],e=[];a.matrixMode=function(b){switch(b){case a.MODELVIEW:f="modelviewMatrix",g=d;break;case a.PROJECTION:f="projectionMatrix",g=e;break;default:throw"invalid matrix mode "+b}},a.loadIdentity=function(){l.identity(a[f])},a.loadMatrix=function(b){for(var c=b.m,d=a[f].m,e=0;16>e;e++)d[e]=c[e]},a.multMatrix=function(b){a.loadMatrix(l.multiply(a[f],b,c))},a.perspective=function(c,d,e,f){a.multMatrix(l.perspective(c,d,e,f,b))},a.frustum=function(c,d,e,f,g,h){a.multMatrix(l.frustum(c,d,e,f,g,h,b))},a.ortho=function(c,d,e,f,g,h){a.multMatrix(l.ortho(c,d,e,f,g,h,b))},a.scale=function(c,d,e){a.multMatrix(l.scale(c,d,e,b))},a.translate=function(c,d,e){a.multMatrix(l.translate(c,d,e,b))},a.rotate=function(c,d,e,f){a.multMatrix(l.rotate(c,d,e,f,b))},a.lookAt=function(c,d,e,f,g,h,i,j,k){a.multMatrix(l.lookAt(c,d,e,f,g,h,i,j,k,b))},a.pushMatrix=function(){g.push(Array.prototype.slice.call(a[f].m))},a.popMatrix=function(){var b=g.pop();a[f].m=k?new Float32Array(b):b},a.project=function(b,c,d,e,f,g){e=e||a.modelviewMatrix,f=f||a.projectionMatrix,g=g||a.getParameter(a.VIEWPORT);var h=f.transformPoint(e.transformPoint(new E(b,c,d)));return new E(g[0]+g[2]*(.5*h.x+.5),g[1]+g[3]*(.5*h.y+.5),.5*h.z+.5)},a.unProject=function(d,e,f,g,h,i){g=g||a.modelviewMatrix,h=h||a.projectionMatrix,i=i||a.getParameter(a.VIEWPORT);var j=new E(2*((d-i[0])/i[2])-1,2*((e-i[1])/i[3])-1,2*f-1);return l.inverse(l.multiply(h,g,b),c).transformPoint(j)},a.matrixMode(a.MODELVIEW)}function d(){var b={mesh:new o({coords:!0,colors:!0,triangles:!1}),mode:-1,coord:[0,0,0,0],color:[1,1,1,1],pointSize:1,shader:new v("      uniform float pointSize;      varying vec4 color;      varying vec4 coord;      void main() {        color = gl_Color;        coord = gl_TexCoord;        gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;        gl_PointSize = pointSize;      }    ","      uniform sampler2D texture;      uniform float pointSize;      uniform bool useTexture;      varying vec4 color;      varying vec4 coord;      void main() {        gl_FragColor = color;        if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);      }    ")};a.pointSize=function(a){b.shader.uniforms({pointSize:a})},a.begin=function(a){if(-1!=b.mode)throw"mismatched gl.begin() and gl.end() calls";b.mode=a,b.mesh.colors=[],b.mesh.coords=[],b.mesh.vertices=[]},a.color=function(a,c,d,e){b.color=1==arguments.length?a.toArray().concat(1):[a,c,d,e||1]},a.texCoord=function(a,c){b.coord=1==arguments.length?a.toArray(2):[a,c]},a.vertex=function(a,c,d){b.mesh.colors.push(b.color),b.mesh.coords.push(b.coord),b.mesh.vertices.push(1==arguments.length?a.toArray():[a,c,d])},a.end=function(){if(-1==b.mode)throw"mismatched gl.begin() and gl.end() calls";b.mesh.compile(),b.shader.uniforms({useTexture:!!a.getParameter(a.TEXTURE_BINDING_2D)}).draw(b.mesh,b.mode),b.mode=-1}}function e(){function j(){for(var a in e)if(i.call(e,a)&&e[a])return!0;return!1}function k(b){var e={};for(var g in b)e[g]="function"==typeof b[g]?function(a){return function(){a.apply(b,arguments)}}(b[g]):b[g];e.original=b,e.x=e.pageX,e.y=e.pageY;for(var h=a.canvas;h;h=h.offsetParent)e.x-=h.offsetLeft,e.y-=h.offsetTop;return f?(e.deltaX=e.x-c,e.deltaY=e.y-d):(e.deltaX=0,e.deltaY=0,f=!0),c=e.x,d=e.y,e.dragging=j(),e.preventDefault=function(){e.original.preventDefault()},e.stopPropagation=function(){e.original.stopPropagation()},e}function l(c){a=b,j()||(g(document,"mousemove",m),g(document,"mouseup",n),h(a.canvas,"mousemove",m),h(a.canvas,"mouseup",n)),e[c.which]=!0,c=k(c),a.onmousedown&&a.onmousedown(c),c.preventDefault()}function m(c){a=b,c=k(c),a.onmousemove&&a.onmousemove(c),c.preventDefault()}function n(c){a=b,e[c.which]=!1,j()||(h(document,"mousemove",m),h(document,"mouseup",n),g(a.canvas,"mousemove",m),g(a.canvas,"mouseup",n)),c=k(c),a.onmouseup&&a.onmouseup(c),c.preventDefault()}function o(){f=!1}function p(){e={},f=!1}var b=a,c=0,d=0,e={},f=!1,i=Object.prototype.hasOwnProperty;g(a.canvas,"mousedown",l),g(a.canvas,"mousemove",m),g(a.canvas,"mouseup",n),g(a.canvas,"mouseover",o),g(a.canvas,"mouseout",o),g(document,"contextmenu",p)}function f(a){var b={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return b[a]||(a>=65&&90>=a?String.fromCharCode(a):null)}function g(a,b,c){a.addEventListener(b,c)}function h(a,b,c){a.removeEventListener(b,c)}function i(){(function(b){a.makeCurrent=function(){a=b}})(a),a.animate=function(){function e(){a=d;var f=(new Date).getTime();a.onupdate&&a.onupdate((f-c)/1e3),a.ondraw&&a.ondraw(),b(e),c=f}var b=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(a){setTimeout(a,1e3/60)},c=(new Date).getTime(),d=a;e()},a.fullscreen=function(b){function h(){a.canvas.width=window.innerWidth-d-e,a.canvas.height=window.innerHeight-c-f,a.viewport(0,0,a.canvas.width,a.canvas.height),!b.camera&&"camera"in b||(a.matrixMode(a.PROJECTION),a.loadIdentity(),a.perspective(b.fov||45,a.canvas.width/a.canvas.height,b.near||.1,b.far||1e3),a.matrixMode(a.MODELVIEW)),a.ondraw&&a.ondraw()}b=b||{};var c=b.paddingTop||0,d=b.paddingLeft||0,e=b.paddingRight||0,f=b.paddingBottom||0;if(!document.body)throw"document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)";document.body.appendChild(a.canvas),document.body.style.overflow="hidden",a.canvas.style.position="absolute",a.canvas.style.left=d+"px",a.canvas.style.top=c+"px",g(window,"resize",h),h()}}function l(){var a=Array.prototype.concat.apply([],arguments);a.length||(a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.m=k?new Float32Array(a):a}function m(){this.unique=[],this.indices=[],this.map={}}function n(a,b){this.buffer=null,this.target=a,this.type=b,this.data=[]}function o(a){a=a||{},this.vertexBuffers={},this.indexBuffers={},this.addVertexBuffer("vertices","gl_Vertex"),a.coords&&this.addVertexBuffer("coords","gl_TexCoord"),a.normals&&this.addVertexBuffer("normals","gl_Normal"),a.colors&&this.addVertexBuffer("colors","gl_Color"),"triangles"in a&&!a.triangles||this.addIndexBuffer("triangles"),a.lines&&this.addIndexBuffer("lines")}function q(a){return new E(2*(1&a)-1,(2&a)-1,(4&a)/2-1)}function r(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE,this.hit=b,this.normal=c}function s(){var b=a.getParameter(a.VIEWPORT),c=a.modelviewMatrix.m,d=new E(c[0],c[4],c[8]),e=new E(c[1],c[5],c[9]),f=new E(c[2],c[6],c[10]),g=new E(c[3],c[7],c[11]);this.eye=new E(-g.dot(d),-g.dot(e),-g.dot(f));var h=b[0],i=h+b[2],j=b[1],k=j+b[3];this.ray00=a.unProject(h,j,1).subtract(this.eye),this.ray10=a.unProject(i,j,1).subtract(this.eye),this.ray01=a.unProject(h,k,1).subtract(this.eye),this.ray11=a.unProject(i,k,1).subtract(this.eye),this.viewport=b}function t(a,b,c){for(;null!=(result=a.exec(b));)c(result)}function v(b,c){function d(a){var b=document.getElementById(a);return b?b.text:a}function j(a,b){var c={},d=/^((\s*\/\/.*\n|\s*#extension.*\n)+)[^]*$/.exec(b);return b=d?d[1]+a+b.substr(d[1].length):a+b,t(/\bgl_\w+\b/g,a,function(a){a in c||(b=b.replace(RegExp("\\b"+a+"\\b","g"),u+a),c[a]=!0)}),b}function k(b,c){var d=a.createShader(b);if(a.shaderSource(d,c),a.compileShader(d),!a.getShaderParameter(d,a.COMPILE_STATUS))throw"compile error: "+a.getShaderInfoLog(d);return d}b=d(b),c=d(c);var e="    uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;  ",f=e+"    attribute vec4 gl_Vertex;    attribute vec4 gl_TexCoord;    attribute vec3 gl_Normal;    attribute vec4 gl_Color;    vec4 ftransform() {      return gl_ModelViewProjectionMatrix * gl_Vertex;    }  ",g="    precision highp float;  "+e,h=b+c,i={};if(t(/\b(gl_[^;]*)\b;/g,e,function(a){var b=a[1];if(-1!=h.indexOf(b)){var c=b.replace(/[a-z_]/g,"");i[c]=u+b}}),-1!=h.indexOf("ftransform")&&(i.MVPM=u+"gl_ModelViewProjectionMatrix"),this.usedMatrices=i,b=j(f,b),c=j(g,c),this.program=a.createProgram(),a.attachShader(this.program,k(a.VERTEX_SHADER,b)),a.attachShader(this.program,k(a.FRAGMENT_SHADER,c)),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))throw"link error: "+a.getProgramInfoLog(this.program);this.attributes={},this.uniformLocations={};var l={};t(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,b+c,function(a){l[a[2]]=1}),this.isSampler=l}function w(a){var b=Object.prototype.toString.call(a);return"[object Array]"==b||"[object Float32Array]"==b}function x(a){var b=Object.prototype.toString.call(a);return"[object Number]"==b||"[object Boolean]"==b}function A(b,c,d){d=d||{},this.id=a.createTexture(),this.width=b,this.height=c,this.format=d.format||a.RGBA,this.type=d.type||a.UNSIGNED_BYTE,a.bindTexture(a.TEXTURE_2D,this.id),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,1),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,d.filter||d.magFilter||a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,d.filter||d.minFilter||a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,d.wrap||d.wrapS||a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,d.wrap||d.wrapT||a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_2D,0,this.format,b,c,0,this.format,this.type,null)}function E(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0}var a,b={create:function(b){b=b||{};var f=document.createElement("canvas");f.width=800,f.height=600,"alpha"in b||(b.alpha=!1);try{a=f.getContext("webgl",b)}catch(g){}try{a=a||f.getContext("experimental-webgl",b)}catch(g){}if(!a)throw"WebGL not supported";return c(),d(),e(),i(),a},keys:{},Matrix:l,Indexer:m,Buffer:n,Mesh:o,HitTest:r,Raytracer:s,Shader:v,Texture:A,Vector:E};g(document,"keydown",function(a){if(!a.altKey&&!a.ctrlKey&&!a.metaKey){var c=f(a.keyCode);c&&(b.keys[c]=!0),b.keys[a.keyCode]=!0}}),g(document,"keyup",function(a){if(!a.altKey&&!a.ctrlKey&&!a.metaKey){var c=f(a.keyCode);c&&(b.keys[c]=!1),b.keys[a.keyCode]=!1}});var j=305397760,k="undefined"!=typeof Float32Array;l.prototype={inverse:function(){return l.inverse(this,new l)},transpose:function(){return l.transpose(this,new l)},multiply:function(a){return l.multiply(this,a,new l)},transformPoint:function(a){var b=this.m;return new E(b[0]*a.x+b[1]*a.y+b[2]*a.z+b[3],b[4]*a.x+b[5]*a.y+b[6]*a.z+b[7],b[8]*a.x+b[9]*a.y+b[10]*a.z+b[11]).divide(b[12]*a.x+b[13]*a.y+b[14]*a.z+b[15])},transformVector:function(a){var b=this.m;return new E(b[0]*a.x+b[1]*a.y+b[2]*a.z,b[4]*a.x+b[5]*a.y+b[6]*a.z,b[8]*a.x+b[9]*a.y+b[10]*a.z)}},l.inverse=function(a,b){b=b||new l;var c=a.m,d=b.m;d[0]=c[5]*c[10]*c[15]-c[5]*c[14]*c[11]-c[6]*c[9]*c[15]+c[6]*c[13]*c[11]+c[7]*c[9]*c[14]-c[7]*c[13]*c[10],d[1]=-c[1]*c[10]*c[15]+c[1]*c[14]*c[11]+c[2]*c[9]*c[15]-c[2]*c[13]*c[11]-c[3]*c[9]*c[14]+c[3]*c[13]*c[10],d[2]=c[1]*c[6]*c[15]-c[1]*c[14]*c[7]-c[2]*c[5]*c[15]+c[2]*c[13]*c[7]+c[3]*c[5]*c[14]-c[3]*c[13]*c[6],d[3]=-c[1]*c[6]*c[11]+c[1]*c[10]*c[7]+c[2]*c[5]*c[11]-c[2]*c[9]*c[7]-c[3]*c[5]*c[10]+c[3]*c[9]*c[6],d[4]=-c[4]*c[10]*c[15]+c[4]*c[14]*c[11]+c[6]*c[8]*c[15]-c[6]*c[12]*c[11]-c[7]*c[8]*c[14]+c[7]*c[12]*c[10],d[5]=c[0]*c[10]*c[15]-c[0]*c[14]*c[11]-c[2]*c[8]*c[15]+c[2]*c[12]*c[11]+c[3]*c[8]*c[14]-c[3]*c[12]*c[10],d[6]=-c[0]*c[6]*c[15]+c[0]*c[14]*c[7]+c[2]*c[4]*c[15]-c[2]*c[12]*c[7]-c[3]*c[4]*c[14]+c[3]*c[12]*c[6],d[7]=c[0]*c[6]*c[11]-c[0]*c[10]*c[7]-c[2]*c[4]*c[11]+c[2]*c[8]*c[7]+c[3]*c[4]*c[10]-c[3]*c[8]*c[6],d[8]=c[4]*c[9]*c[15]-c[4]*c[13]*c[11]-c[5]*c[8]*c[15]+c[5]*c[12]*c[11]+c[7]*c[8]*c[13]-c[7]*c[12]*c[9],d[9]=-c[0]*c[9]*c[15]+c[0]*c[13]*c[11]+c[1]*c[8]*c[15]-c[1]*c[12]*c[11]-c[3]*c[8]*c[13]+c[3]*c[12]*c[9],d[10]=c[0]*c[5]*c[15]-c[0]*c[13]*c[7]-c[1]*c[4]*c[15]+c[1]*c[12]*c[7]+c[3]*c[4]*c[13]-c[3]*c[12]*c[5],d[11]=-c[0]*c[5]*c[11]+c[0]*c[9]*c[7]+c[1]*c[4]*c[11]-c[1]*c[8]*c[7]-c[3]*c[4]*c[9]+c[3]*c[8]*c[5],d[12]=-c[4]*c[9]*c[14]+c[4]*c[13]*c[10]+c[5]*c[8]*c[14]-c[5]*c[12]*c[10]-c[6]*c[8]*c[13]+c[6]*c[12]*c[9],d[13]=c[0]*c[9]*c[14]-c[0]*c[13]*c[10]-c[1]*c[8]*c[14]+c[1]*c[12]*c[10]+c[2]*c[8]*c[13]-c[2]*c[12]*c[9],d[14]=-c[0]*c[5]*c[14]+c[0]*c[13]*c[6]+c[1]*c[4]*c[14]-c[1]*c[12]*c[6]-c[2]*c[4]*c[13]+c[2]*c[12]*c[5],d[15]=c[0]*c[5]*c[10]-c[0]*c[9]*c[6]-c[1]*c[4]*c[10]+c[1]*c[8]*c[6]+c[2]*c[4]*c[9]-c[2]*c[8]*c[5];for(var e=c[0]*d[0]+c[1]*d[4]+c[2]*d[8]+c[3]*d[12],f=0;16>f;f++)d[f]/=e;return b},l.transpose=function(a,b){b=b||new l;var c=a.m,d=b.m;return d[0]=c[0],d[1]=c[4],d[2]=c[8],d[3]=c[12],d[4]=c[1],d[5]=c[5],d[6]=c[9],d[7]=c[13],d[8]=c[2],d[9]=c[6],d[10]=c[10],d[11]=c[14],d[12]=c[3],d[13]=c[7],d[14]=c[11],d[15]=c[15],b},l.multiply=function(a,b,c){c=c||new l;var d=a.m,e=b.m,f=c.m;return f[0]=d[0]*e[0]+d[1]*e[4]+d[2]*e[8]+d[3]*e[12],f[1]=d[0]*e[1]+d[1]*e[5]+d[2]*e[9]+d[3]*e[13],f[2]=d[0]*e[2]+d[1]*e[6]+d[2]*e[10]+d[3]*e[14],f[3]=d[0]*e[3]+d[1]*e[7]+d[2]*e[11]+d[3]*e[15],f[4]=d[4]*e[0]+d[5]*e[4]+d[6]*e[8]+d[7]*e[12],f[5]=d[4]*e[1]+d[5]*e[5]+d[6]*e[9]+d[7]*e[13],f[6]=d[4]*e[2]+d[5]*e[6]+d[6]*e[10]+d[7]*e[14],f[7]=d[4]*e[3]+d[5]*e[7]+d[6]*e[11]+d[7]*e[15],f[8]=d[8]*e[0]+d[9]*e[4]+d[10]*e[8]+d[11]*e[12],f[9]=d[8]*e[1]+d[9]*e[5]+d[10]*e[9]+d[11]*e[13],f[10]=d[8]*e[2]+d[9]*e[6]+d[10]*e[10]+d[11]*e[14],f[11]=d[8]*e[3]+d[9]*e[7]+d[10]*e[11]+d[11]*e[15],f[12]=d[12]*e[0]+d[13]*e[4]+d[14]*e[8]+d[15]*e[12],f[13]=d[12]*e[1]+d[13]*e[5]+d[14]*e[9]+d[15]*e[13],f[14]=d[12]*e[2]+d[13]*e[6]+d[14]*e[10]+d[15]*e[14],f[15]=d[12]*e[3]+d[13]*e[7]+d[14]*e[11]+d[15]*e[15],c},l.identity=function(a){a=a||new l;var b=a.m;return b[0]=b[5]=b[10]=b[15]=1,b[1]=b[2]=b[3]=b[4]=b[6]=b[7]=b[8]=b[9]=b[11]=b[12]=b[13]=b[14]=0,a},l.perspective=function(a,b,c,d,e){var f=Math.tan(a*Math.PI/360)*c,g=f*b;return l.frustum(-g,g,-f,f,c,d,e)},l.frustum=function(a,b,c,d,e,f,g){g=g||new l;var h=g.m;return h[0]=2*e/(b-a),h[1]=0,h[2]=(b+a)/(b-a),h[3]=0,h[4]=0,h[5]=2*e/(d-c),h[6]=(d+c)/(d-c),h[7]=0,h[8]=0,h[9]=0,h[10]=-(f+e)/(f-e),h[11]=-2*f*e/(f-e),h[12]=0,h[13]=0,h[14]=-1,h[15]=0,g},l.ortho=function(a,b,c,d,e,f,g){g=g||new l;var h=g.m;return h[0]=2/(b-a),h[1]=0,h[2]=0,h[3]=-(b+a)/(b-a),h[4]=0,h[5]=2/(d-c),h[6]=0,h[7]=-(d+c)/(d-c),h[8]=0,h[9]=0,h[10]=-2/(f-e),h[11]=-(f+e)/(f-e),h[12]=0,h[13]=0,h[14]=0,h[15]=1,g},l.scale=function(a,b,c,d){d=d||new l;var e=d.m;return e[0]=a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=b,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=c,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,d},l.translate=function(a,b,c,d){d=d||new l;var e=d.m;return e[0]=1,e[1]=0,e[2]=0,e[3]=a,e[4]=0,e[5]=1,e[6]=0,e[7]=b,e[8]=0,e[9]=0,e[10]=1,e[11]=c,e[12]=0,e[13]=0,e[14]=0,e[15]=1,d},l.rotate=function(a,b,c,d,e){if(!a||!b&&!c&&!d)return l.identity(e);e=e||new l;var f=e.m,g=Math.sqrt(b*b+c*c+d*d);a*=Math.PI/180,b/=g,c/=g,d/=g;var h=Math.cos(a),i=Math.sin(a),j=1-h;return f[0]=b*b*j+h,f[1]=b*c*j-d*i,f[2]=b*d*j+c*i,f[3]=0,f[4]=c*b*j+d*i,f[5]=c*c*j+h,f[6]=c*d*j-b*i,f[7]=0,f[8]=d*b*j-c*i,f[9]=d*c*j+b*i,f[10]=d*d*j+h,f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,e},l.lookAt=function(a,b,c,d,e,f,g,h,i,j){j=j||new l;var k=j.m,m=new E(a,b,c),n=new E(d,e,f),o=new E(g,h,i),p=m.subtract(n).unit(),q=o.cross(p).unit(),r=p.cross(q).unit();return k[0]=q.x,k[1]=q.y,k[2]=q.z,k[3]=-q.dot(m),k[4]=r.x,k[5]=r.y,k[6]=r.z,k[7]=-r.dot(m),k[8]=p.x,k[9]=p.y,k[10]=p.z,k[11]=-p.dot(m),k[12]=0,k[13]=0,k[14]=0,k[15]=1,j},m.prototype={add:function(a){var b=JSON.stringify(a);return b in this.map||(this.map[b]=this.unique.length,this.unique.push(a)),this.map[b]}},n.prototype={compile:function(b){for(var c=[],d=0,e=1e4;this.data.length>d;d+=e)c=Array.prototype.concat.apply(c,this.data.slice(d,d+e));var f=this.data.length?c.length/this.data.length:0;if(f!=Math.round(f))throw"buffer elements not of consistent size, average size is "+f;this.buffer=this.buffer||a.createBuffer(),this.buffer.length=c.length,this.buffer.spacing=f,a.bindBuffer(this.target,this.buffer),a.bufferData(this.target,new this.type(c),b||a.STATIC_DRAW)}},o.prototype={addVertexBuffer:function(b,c){var d=this.vertexBuffers[c]=new n(a.ARRAY_BUFFER,Float32Array);d.name=b,this[b]=[]},addIndexBuffer:function(b){this.indexBuffers[b]=new n(a.ELEMENT_ARRAY_BUFFER,Uint16Array),this[b]=[]},compile:function(){for(var a in this.vertexBuffers){var b=this.vertexBuffers[a];b.data=this[b.name],b.compile()}for(var c in this.indexBuffers){var b=this.indexBuffers[c];b.data=this[c],b.compile()}},transform:function(a){if(this.vertices=this.vertices.map(function(b){return a.transformPoint(E.fromArray(b)).toArray()}),this.normals){var b=a.inverse().transpose();this.normals=this.normals.map(function(a){return b.transformVector(E.fromArray(a)).unit().toArray()})}return this.compile(),this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var a=0;this.vertices.length>a;a++)this.normals[a]=new E;for(var a=0;this.triangles.length>a;a++){var b=this.triangles[a],c=E.fromArray(this.vertices[b[0]]),d=E.fromArray(this.vertices[b[1]]),e=E.fromArray(this.vertices[b[2]]),f=d.subtract(c).cross(e.subtract(c)).unit();this.normals[b[0]]=this.normals[b[0]].add(f),this.normals[b[1]]=this.normals[b[1]].add(f),this.normals[b[2]]=this.normals[b[2]].add(f)}for(var a=0;this.vertices.length>a;a++)this.normals[a]=this.normals[a].unit().toArray();return this.compile(),this},computeWireframe:function(){for(var a=new m,b=0;this.triangles.length>b;b++)for(var c=this.triangles[b],d=0;c.length>d;d++){var e=c[d],f=c[(d+1)%c.length];a.add([Math.min(e,f),Math.max(e,f)])}return this.lines||this.addIndexBuffer("lines"),this.lines=a.unique,this.compile(),this},getAABB:function(){var a={min:new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};a.max=a.min.negative();for(var b=0;this.vertices.length>b;b++){var c=E.fromArray(this.vertices[b]);a.min=E.min(a.min,c),a.max=E.max(a.max,c)}return a},getBoundingSphere:function(){for(var a=this.getAABB(),b={center:a.min.add(a.max).divide(2),radius:0},c=0;this.vertices.length>c;c++)b.radius=Math.max(b.radius,E.fromArray(this.vertices[c]).subtract(b.center).length());return b}},o.plane=function(a){a=a||{};var b=new o(a);detailX=a.detailX||a.detail||1,detailY=a.detailY||a.detail||1;for(var c=0;detailY>=c;c++)for(var d=c/detailY,e=0;detailX>=e;e++){var f=e/detailX;if(b.vertices.push([2*f-1,2*d-1,0]),b.coords&&b.coords.push([f,d]),b.normals&&b.normals.push([0,0,1]),detailX>e&&detailY>c){var g=e+c*(detailX+1);b.triangles.push([g,g+1,g+detailX+1]),b.triangles.push([g+detailX+1,g+1,g+detailX+2])}}return b.compile(),b};var p=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];o.cube=function(a){for(var b=new o(a),c=0;p.length>c;c++){for(var d=p[c],e=4*c,f=0;4>f;f++){var g=d[f];b.vertices.push(q(g).toArray()),b.coords&&b.coords.push([1&f,(2&f)/2]),b.normals&&b.normals.push(d.slice(4,7))}b.triangles.push([e,e+1,e+2]),b.triangles.push([e+2,e+1,e+3])}return b.compile(),b},o.sphere=function(a){function b(a,b,c){return h?[a,c,b]:[a,b,c]}function c(a){return a+(a-a*a)/2}a=a||{};var d=new o(a),e=new m;detail=a.detail||6;for(var f=0;8>f;f++)for(var g=q(f),h=g.x*g.y*g.z>0,i=[],j=0;detail>=j;j++){for(var k=0;detail>=j+k;k++){var l=j/detail,n=k/detail,p=(detail-j-k)/detail,r={vertex:new E(c(l),c(n),c(p)).unit().multiply(g).toArray()};d.coords&&(r.coord=g.y>0?[1-l,p]:[p,1-l]),i.push(e.add(r))}if(j>0)for(var k=0;detail>=j+k;k++){var l=(j-1)*(detail+1)+(j-1-(j-1)*(j-1))/2+k,n=j*(detail+1)+(j-j*j)/2+k;d.triangles.push(b(i[l],i[l+1],i[n])),detail>j+k&&d.triangles.push(b(i[n],i[l+1],i[n+1]))}}return d.vertices=e.unique.map(function(a){return a.vertex}),d.coords&&(d.coords=e.unique.map(function(a){return a.coord})),d.normals&&(d.normals=d.vertices),d.compile(),d},o.load=function(a,b){b=b||{},"coords"in b||(b.coords=!!a.coords),"normals"in b||(b.normals=!!a.normals),"colors"in b||(b.colors=!!a.colors),"triangles"in b||(b.triangles=!!a.triangles),"lines"in b||(b.lines=!!a.lines);var c=new o(b);return c.vertices=a.vertices,c.coords&&(c.coords=a.coords),c.normals&&(c.normals=a.normals),c.colors&&(c.colors=a.colors),c.triangles&&(c.triangles=a.triangles),c.lines&&(c.lines=a.lines),c.compile(),c},r.prototype={mergeWith:function(a){a.t>0&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}},s.prototype={getRayForPixel:function(a,b){a=(a-this.viewport[0])/this.viewport[2],b=1-(b-this.viewport[1])/this.viewport[3];var c=E.lerp(this.ray00,this.ray10,a),d=E.lerp(this.ray01,this.ray11,a);return E.lerp(c,d,b).unit()}},s.hitTestBox=function(a,b,c,d){var e=c.subtract(a).divide(b),f=d.subtract(a).divide(b),g=E.min(e,f),h=E.max(e,f),i=g.max(),j=h.min();if(i>0&&j>i){var k=1e-6,l=a.add(b.multiply(i));return c=c.add(k),d=d.subtract(k),new r(i,l,new E((l.x>d.x)-(l.x<c.x),(l.y>d.y)-(l.y<c.y),(l.z>d.z)-(l.z<c.z)))}return null},s.hitTestSphere=function(a,b,c,d){var e=a.subtract(c),f=b.dot(b),g=2*b.dot(e),h=e.dot(e)-d*d,i=g*g-4*f*h;if(i>0){var j=(-g-Math.sqrt(i))/(2*f),k=a.add(b.multiply(j));return new r(j,k,k.subtract(c).divide(d))}return null},s.hitTestTriangle=function(a,b,c,d,e){var f=d.subtract(c),g=e.subtract(c),h=f.cross(g).unit(),i=h.dot(c.subtract(a))/h.dot(b);if(i>0){var j=a.add(b.multiply(i)),k=j.subtract(c),l=g.dot(g),m=g.dot(f),n=g.dot(k),o=f.dot(f),p=f.dot(k),q=l*o-m*m,s=(o*n-m*p)/q,t=(l*p-m*n)/q;if(s>=0&&t>=0&&1>=s+t)return new r(i,j,h)}return null};var u="LIGHTGL";new l,new l,v.prototype={uniforms:function(b){a.useProgram(this.program);for(var c in b){var d=this.uniformLocations[c]||a.getUniformLocation(this.program,c);if(d){this.uniformLocations[c]=d;var e=b[c];if(e instanceof E?e=[e.x,e.y,e.z]:e instanceof l&&(e=e.m),w(e))switch(e.length){case 1:a.uniform1fv(d,new Float32Array(e));break;case 2:a.uniform2fv(d,new Float32Array(e));break;case 3:a.uniform3fv(d,new Float32Array(e));break;case 4:a.uniform4fv(d,new Float32Array(e));break;case 9:a.uniformMatrix3fv(d,!1,new Float32Array([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]]));break;case 16:a.uniformMatrix4fv(d,!1,new Float32Array([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]]));break;default:throw"don't know how to load uniform \""+c+'" of length '+e.length}else{if(!x(e))throw'attempted to set uniform "'+c+'" to invalid value '+e;(this.isSampler[c]?a.uniform1i:a.uniform1f).call(a,d,e)}}}return this},draw:function(b,c){this.drawBuffers(b.vertexBuffers,b.indexBuffers[c==a.LINES?"lines":"triangles"],2>arguments.length?a.TRIANGLES:c)},drawBuffers:function(b,c,d){var e=this.usedMatrices,f=a.modelviewMatrix,g=a.projectionMatrix,h=e.MVMI||e.NM?f.inverse():null,i=e.PMI?g.inverse():null,j=e.MVPM||e.MVPMI?g.multiply(f):null,k={};if(e.MVM&&(k[e.MVM]=f),e.MVMI&&(k[e.MVMI]=h),e.PM&&(k[e.PM]=g),e.PMI&&(k[e.PMI]=i),e.MVPM&&(k[e.MVPM]=j),e.MVPMI&&(k[e.MVPMI]=j.inverse()),e.NM){var l=h.m;k[e.NM]=[l[0],l[4],l[8],l[1],l[5],l[9],l[2],l[6],l[10]]}this.uniforms(k);var m=0;for(var n in b){var o=b[n],p=this.attributes[n]||a.getAttribLocation(this.program,n.replace(/^(gl_.*)$/,u+"$1"));-1!=p&&o.buffer&&(this.attributes[n]=p,a.bindBuffer(a.ARRAY_BUFFER,o.buffer),a.enableVertexAttribArray(p),a.vertexAttribPointer(p,o.buffer.spacing,a.FLOAT,!1,0,0),m=o.buffer.length/o.buffer.spacing)}for(var n in this.attributes)n in b||a.disableVertexAttribArray(this.attributes[n]);return!m||c&&!c.buffer||(c?(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.buffer),a.drawElements(d,c.buffer.length,a.UNSIGNED_SHORT,0)):a.drawArrays(d,0,m)),this}};var B,C,D;return A.prototype={bind:function(b){a.activeTexture(a.TEXTURE0+(b||0)),a.bindTexture(a.TEXTURE_2D,this.id)},unbind:function(b){a.activeTexture(a.TEXTURE0+(b||0)),a.bindTexture(a.TEXTURE_2D,null)},drawTo:function(b){var c=a.getParameter(a.VIEWPORT);B=B||a.createFramebuffer(),C=C||a.createRenderbuffer(),a.bindFramebuffer(a.FRAMEBUFFER,B),a.bindRenderbuffer(a.RENDERBUFFER,C),(this.width!=C.width||this.height!=C.height)&&(C.width=this.width,C.height=this.height,a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height)),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.id,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,C),a.viewport(0,0,this.width,this.height),b(),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.viewport(c[0],c[1],c[2],c[3])},swapWith:function(a){var b;b=a.id,a.id=this.id,this.id=b,b=a.width,a.width=this.width,this.width=b,b=a.height,a.height=this.height,this.height=b}},A.fromImage=function(b,c){c=c||{};var d=new A(b.width,b.height,c);try{a.texImage2D(a.TEXTURE_2D,0,d.format,d.format,d.type,b)}catch(e){throw"file:"==location.protocol?'image not loaded for security reasons (serve this page over "http://" instead)':"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)"}return c.minFilter&&c.minFilter!=a.NEAREST&&c.minFilter!=a.LINEAR&&a.generateMipmap(a.TEXTURE_2D),d},A.fromURL=function(b,c){D=D||function(){var a=document.createElement("canvas").getContext("2d");a.canvas.width=a.canvas.height=128;for(var b=0;a.canvas.height>b;b+=16)for(var c=0;a.canvas.width>c;c+=16)a.fillStyle=16&(c^b)?"#FFF":"#DDD",a.fillRect(c,b,16,16);return a.canvas}();var d=A.fromImage(D,c),e=new Image,f=a;return e.onload=function(){f.makeCurrent(),A.fromImage(e,c).swapWith(d)},e.src=b,d},E.prototype={negative:function(){return new E(-this.x,-this.y,-this.z)},add:function(a){return a instanceof E?new E(this.x+a.x,this.y+a.y,this.z+a.z):new E(this.x+a,this.y+a,this.z+a)},subtract:function(a){return a instanceof E?new E(this.x-a.x,this.y-a.y,this.z-a.z):new E(this.x-a,this.y-a,this.z-a)},multiply:function(a){return a instanceof E?new E(this.x*a.x,this.y*a.y,this.z*a.z):new E(this.x*a,this.y*a,this.z*a)},divide:function(a){return a instanceof E?new E(this.x/a.x,this.y/a.y,this.z/a.z):new E(this.x/a,this.y/a,this.z/a)},equals:function(a){return this.x==a.x&&this.y==a.y&&this.z==a.z},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},cross:function(a){return new E(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},toArray:function(a){return[this.x,this.y,this.z].slice(0,a||3)},clone:function(){return new E(this.x,this.y,this.z)},init:function(a,b,c){return this.x=a,this.y=b,this.z=c,this}},E.negative=function(a,b){return b.x=-a.x,b.y=-a.y,b.z=-a.z,b},E.add=function(a,b,c){return b instanceof E?(c.x=a.x+b.x,c.y=a.y+b.y,c.z=a.z+b.z):(c.x=a.x+b,c.y=a.y+b,c.z=a.z+b),c},E.subtract=function(a,b,c){return b instanceof E?(c.x=a.x-b.x,c.y=a.y-b.y,c.z=a.z-b.z):(c.x=a.x-b,c.y=a.y-b,c.z=a.z-b),c},E.multiply=function(a,b,c){return b instanceof E?(c.x=a.x*b.x,c.y=a.y*b.y,c.z=a.z*b.z):(c.x=a.x*b,c.y=a.y*b,c.z=a.z*b),c},E.divide=function(a,b,c){return b instanceof E?(c.x=a.x/b.x,c.y=a.y/b.y,c.z=a.z/b.z):(c.x=a.x/b,c.y=a.y/b,c.z=a.z/b),c},E.cross=function(a,b,c){return c.x=a.y*b.z-a.z*b.y,c.y=a.z*b.x-a.x*b.z,c.z=a.x*b.y-a.y*b.x,c},E.unit=function(a,b){var c=a.length();return b.x=a.x/c,b.y=a.y/c,b.z=a.z/c,b},E.fromAngles=function(a,b){return new E(Math.cos(a)*Math.cos(b),Math.sin(b),Math.sin(a)*Math.cos(b))},E.randomDirection=function(){return E.fromAngles(2*Math.random()*Math.PI,Math.asin(2*Math.random()-1))},E.min=function(a,b){return new E(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.min(a.z,b.z))},E.max=function(a,b){return new E(Math.max(a.x,b.x),Math.max(a.y,b.y),Math.max(a.z,b.z))},E.lerp=function(a,b,c){return b.subtract(a).multiply(c).add(a)},E.fromArray=function(a){return new E(a[0],a[1],a[2])},b}();